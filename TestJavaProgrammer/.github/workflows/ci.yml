# CI/CD Pipeline for Customer Management API
#
# Purpose: Builds, tests, and validates the Spring Boot application
# Trigger: On push to main/develop, PRs to main, and manual dispatch
# Prerequisites:
#   - Java 17, 21 (matrix build)
#   - Maven 3.9+
#   - Secrets: SLACK_WEBHOOK_URL (optional, for failure notifications)
#
# Outputs: Test reports, code coverage, build artifacts, GitHub Packages, Docker images

name: CI Build and Test

on:
  push:
    branches: [main, develop, release]
    tags:
      - 'v*'
    paths:
      - 'TestJavaProgrammer/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'TestJavaProgrammer/**'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false
      publish_packages:
        description: 'Publish to GitHub Packages'
        required: false
        type: boolean
        default: false
      build_docker:
        description: 'Build and push Docker image'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  checks: write
  pull-requests: write
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'
  WORKING_DIRECTORY: TestJavaProgrammer
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/customer-api

jobs:
  build:
    name: Build and Test (Java ${{ matrix.java-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        java-version: ['17', '21']
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.6.0
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven

      # Note: Removed redundant Cache Maven dependencies step - setup-java handles caching with cache: maven

      - name: Validate Maven project
        run: mvn validate --batch-mode

      - name: Build with Maven
        run: mvn clean compile --batch-mode -DskipTests

      - name: Run tests with coverage
        if: ${{ inputs.skip_tests != true }}
        run: mvn test jacoco:report --batch-mode
        env:
          CI: true

      - name: Upload coverage report
        if: ${{ inputs.skip_tests != true && matrix.java-version == '17' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.0
        with:
          name: coverage-report
          path: ${{ env.WORKING_DIRECTORY }}/target/site/jacoco/
          retention-days: 7

      - name: Generate coverage summary
        if: ${{ inputs.skip_tests != true && matrix.java-version == '17' }}
        run: |
          if [ -f target/site/jacoco/index.html ]; then
            echo "## Code Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "Coverage report generated. View in artifacts." >> $GITHUB_STEP_SUMMARY
            # Extract coverage percentage if available
            COVERAGE=$(grep -oP 'Total[^%]*\K[0-9]+(?=%)' target/site/jacoco/index.html 2>/dev/null | head -1 || echo "N/A")
            if [ "$COVERAGE" != "N/A" ]; then
              echo "- **Line Coverage**: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Generate test report
        uses: dorny/test-reporter@31a54ee7ebcacc03a09ea97a7e5465a47b84aea5 # v1.9.1
        if: success() || failure()
        with:
          name: JUnit Test Results
          path: ${{ env.WORKING_DIRECTORY }}/target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false

      - name: Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.0
        if: always()
        with:
          name: test-results-java-${{ matrix.java-version }}
          path: ${{ env.WORKING_DIRECTORY }}/target/surefire-reports/
          retention-days: 7

      - name: Package application
        run: mvn package --batch-mode -DskipTests

      - name: Upload build artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.0
        with:
          name: application-jar-java-${{ matrix.java-version }}-${{ github.sha }}
          path: ${{ env.WORKING_DIRECTORY }}/target/*.jar
          retention-days: 30
          if-no-files-found: error

      - name: Generate build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Java Version**: ${{ matrix.java-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: ‚úÖ Success" >> $GITHUB_STEP_SUMMARY

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.6.0
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      # Note: continue-on-error is intentional for code quality checks.
      # These are advisory and should not block the build, allowing gradual improvement.
      - name: Check code formatting with Checkstyle
        run: |
          mvn checkstyle:check --batch-mode || echo "::warning::Checkstyle check completed with warnings"
        continue-on-error: true

      - name: Run SpotBugs analysis
        run: |
          mvn spotbugs:check --batch-mode || echo "::warning::SpotBugs analysis completed with findings"
        continue-on-error: true

  verify-api-docs:
    name: Verify API Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate OpenAPI specification
        run: |
          if [ -f "docs/api/openapi.yaml" ]; then
            echo "‚úÖ OpenAPI specification found"
            echo "## API Documentation" >> $GITHUB_STEP_SUMMARY
            echo "- OpenAPI specification: \`docs/api/openapi.yaml\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "::warning::OpenAPI specification not found at docs/api/openapi.yaml"
          fi

  # Failure notification job - runs when any job fails
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build, code-quality, verify-api-docs]
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "## ‚ùå CI Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please investigate the failed jobs above." >> $GITHUB_STEP_SUMMARY
          
      # Uncomment to enable Slack notifications (requires SLACK_WEBHOOK_URL secret)
      # - name: Send Slack notification
      #   if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
      #   uses: slackapi/slack-github-action@485a9d42d3a73031f12ec201c457e2162c45d02d # v2.0.0
      #   with:
      #     webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     webhook-type: incoming-webhook
      #     payload: |
      #       {
      #         "text": "‚ùå CI Build Failed",
      #         "blocks": [
      #           {
      #             "type": "section",
      #             "text": {
      #               "type": "mrkdwn",
      #               "text": "*CI Build Failed* for `${{ github.repository }}`\n*Branch:* `${{ github.ref_name }}`\n*Commit:* `${{ github.sha }}`\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
      #             }
      #           }
      #         ]
      #       }

  # Publish JAR to GitHub Packages
  # Runs on: tags (v*), main branch, or manual trigger with publish_packages=true
  publish-packages:
    name: Publish to GitHub Packages
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    if: |
      github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch' && inputs.publish_packages == true
    
    permissions:
      contents: read
      packages: write
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.6.0
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Download build artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: application-jar-java-17-${{ github.sha }}
          path: ${{ env.WORKING_DIRECTORY }}/target/

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION="0.0.1-SNAPSHOT"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            VERSION="0.0.1-develop-SNAPSHOT"
          else
            VERSION="0.0.1-${{ github.ref_name }}-SNAPSHOT"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Publishing version: $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Update version in pom.xml
        run: |
          mvn versions:set -DnewVersion=${{ steps.version.outputs.version }} --batch-mode
          mvn versions:commit --batch-mode

      - name: Publish to GitHub Packages
        run: mvn deploy --batch-mode -DskipTests -DaltDeploymentRepository=github::https://maven.pkg.github.com/${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate publish summary
        run: |
          echo "## üì¶ Published to GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Group ID**: com.example" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact ID**: demo" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: maven.pkg.github.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo '```xml' >> $GITHUB_STEP_SUMMARY
          echo '<dependency>' >> $GITHUB_STEP_SUMMARY
          echo '  <groupId>com.example</groupId>' >> $GITHUB_STEP_SUMMARY
          echo '  <artifactId>demo</artifactId>' >> $GITHUB_STEP_SUMMARY
          echo '  <version>${{ steps.version.outputs.version }}</version>' >> $GITHUB_STEP_SUMMARY
          echo '</dependency>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Build and push Docker image to GitHub Container Registry
  # Runs on: tags (v*), main/develop branches, or manual trigger with build_docker=true
  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build
    if: |
      github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') ||
      github.event_name == 'workflow_dispatch' && inputs.build_docker == true
    
    permissions:
      contents: read
      packages: write
      security-events: write
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIRECTORY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download build artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: application-jar-java-17-${{ github.sha }}
          path: ${{ env.WORKING_DIRECTORY }}/target/

      - name: Set up QEMU for multi-architecture builds
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@902fa8ec7d6ecbf8d84d538b9b233a880e428804 # v5.7.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tag with version for release tags
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # Tag with branch name for branches
            type=ref,event=branch
            # Tag with PR number for pull requests
            type=ref,event=pr
            # Tag with sha for all builds
            type=sha,prefix=sha-
            # Latest tag only for main branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        id: docker-build
        uses: docker/build-push-action@14487ce63c7a62a4a324b0bfb37086795e31c6c1 # v6.16.0
        with:
          context: ${{ env.WORKING_DIRECTORY }}
          file: ${{ env.WORKING_DIRECTORY }}/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            JAR_FILE=target/*.jar

      # Vulnerability scanning with Trivy
      # Note: continue-on-error is intentional for security scanning.
      # Scans are informational and should not block CI; results are uploaded to Security tab.
      - name: Scan Docker image for vulnerabilities
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5 # v0.29.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name == 'main' && 'latest' || github.ref_name }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
        continue-on-error: true

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@6bb031afdd8eb862ea3fc1848194185e076637e5 # v3.28.10
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      # Generate SBOM (Software Bill of Materials) for supply chain security
      # Note: continue-on-error is intentional for SBOM generation.
      # SBOM is supplementary metadata and should not block the build pipeline.
      - name: Generate SBOM
        uses: anchore/sbom-action@f325610c9f50a54015d37c8d16cb3b0e2c8f4de0 # v0.17.8
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name == 'main' && 'latest' || github.ref_name }}
          artifact-name: sbom-${{ github.sha }}.spdx.json
          output-file: ./sbom.spdx.json
        continue-on-error: true

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.0
        if: always()
        with:
          name: sbom-${{ github.sha }}
          path: ./sbom.spdx.json
          retention-days: 30
        continue-on-error: true

      - name: Generate Docker summary
        run: |
          echo "## üê≥ Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
